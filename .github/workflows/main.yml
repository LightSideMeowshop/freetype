name: Build
on: [push, pull_request]
jobs:
  Build:
    name: ${{ matrix.platform.name }}
    runs-on: ${{ matrix.platform.os }}
    strategy:
      fail-fast: false
      matrix:
        platform:
        - { name: Windows (x64), os: windows-latest, flags: -A x64, triplet: x64-windows-static }
        - { name: Windows (ARM64), os: windows-latest, flags: -A ARM64, triplet: arm64-windows-static }
        - { name: Windows (x86), os: windows-latest, flags: -A Win32, triplet: x86-windows-static }
        - { name: UWP (x64), os: windows-latest, flags: -A x64 -DCMAKE_SYSTEM_NAME=WindowsStore -DCMAKE_SYSTEM_VERSION="10.0", triplet: x64-uwp }
        - { name: UWP (ARM64), os: windows-latest, flags: -A ARM64 -DCMAKE_SYSTEM_NAME=WindowsStore -DCMAKE_SYSTEM_VERSION="10.0", triplet: arm64-uwp }
        - { name: UWP (x86), os: windows-latest, flags: -A Win32 -DCMAKE_SYSTEM_NAME=WindowsStore -DCMAKE_SYSTEM_VERSION="10.0", triplet: x86-uwp }
        - { name: Linux, os: ubuntu-latest, flags: "", triplet: "" }
        - { name: MacOS, os: macos-latest, flags: -DCMAKE_OSX_ARCHITECTURES=arm64\;x86_64 -DCMAKE_OSX_DEPLOYMENT_TARGET=11, triplet: "" }
    steps:
      - uses: actions/checkout@v4

      # Windows: Install libpng via vcpkg
      - name: Install libpng (Windows/UWP)
        if: runner.os == 'Windows'
        run: |
          vcpkg install libpng:${{ matrix.platform.triplet }}
          vcpkg install zlib:${{ matrix.platform.triplet }}

      # Linux: Install libpng via apt
      - name: Install libpng (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y libpng-dev zlib1g-dev

      # macOS: Build libpng from source for universal binary
      - name: Build libpng (macOS)
        if: runner.os == 'macOS'
        run: |
          # Build zlib
          git clone --depth 1 --branch v1.3.1 https://github.com/madler/zlib.git zlib-src
          cd zlib-src && mkdir build && cd build
          cmake .. -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_OSX_ARCHITECTURES="arm64;x86_64" \
            -DCMAKE_OSX_DEPLOYMENT_TARGET=11 \
            -DCMAKE_INSTALL_PREFIX=${{ github.workspace }}/deps \
            -DCMAKE_POLICY_VERSION_MINIMUM=3.5
          cmake --build . -j$(sysctl -n hw.ncpu)
          cmake --install .
          cd ../..
          
          # Build libpng
          git clone --depth 1 --branch v1.6.43 https://github.com/glennrp/libpng.git libpng-src
          cd libpng-src && mkdir build && cd build
          cmake .. -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_OSX_ARCHITECTURES="arm64;x86_64" \
            -DCMAKE_OSX_DEPLOYMENT_TARGET=11 \
            -DCMAKE_INSTALL_PREFIX=${{ github.workspace }}/deps \
            -DPNG_SHARED=OFF -DPNG_STATIC=ON -DPNG_TESTS=OFF \
            -DZLIB_LIBRARY=${{ github.workspace }}/deps/lib/libz.a \
            -DZLIB_INCLUDE_DIR=${{ github.workspace }}/deps/include \
            -DCMAKE_POLICY_VERSION_MINIMUM=3.5
          cmake --build . -j$(sysctl -n hw.ncpu)
          cmake --install .

      - name: Apply Win64 patch
        if: matrix.platform.name == 'Windows (x64)' || matrix.platform.name == 'Windows (ARM64)' || matrix.platform.name == 'UWP (x64)' || matrix.platform.name == 'UWP (ARM64)'
        run: git apply 0001-Win64.patch

      - name: Configure (CMake) - Windows/UWP
        if: runner.os == 'Windows'
        run: >
          cmake -B build
          -DBUILD_SHARED_LIBS=1
          -DCMAKE_DISABLE_FIND_PACKAGE_HarfBuzz=1
          -DCMAKE_DISABLE_FIND_PACKAGE_BZip2=1
          -DCMAKE_DISABLE_FIND_PACKAGE_BrotliDec=1
          -DFT_REQUIRE_PNG=ON
          -DFT_REQUIRE_ZLIB=ON
          -DCMAKE_TOOLCHAIN_FILE=C:/vcpkg/scripts/buildsystems/vcpkg.cmake
          -DVCPKG_TARGET_TRIPLET=${{ matrix.platform.triplet }}
          -DCMAKE_POLICY_VERSION_MINIMUM=3.5
          ${{ matrix.platform.flags }}

      - name: Configure (CMake) - Linux
        if: runner.os == 'Linux'
        run: >
          cmake -B build
          -DBUILD_SHARED_LIBS=1
          -DCMAKE_DISABLE_FIND_PACKAGE_HarfBuzz=1
          -DCMAKE_DISABLE_FIND_PACKAGE_BZip2=1
          -DCMAKE_DISABLE_FIND_PACKAGE_BrotliDec=1
          -DFT_REQUIRE_PNG=ON
          -DFT_REQUIRE_ZLIB=ON
          -DCMAKE_POLICY_VERSION_MINIMUM=3.5
          ${{ matrix.platform.flags }}

      - name: Configure (CMake) - macOS
        if: runner.os == 'macOS'
        run: >
          cmake -B build
          -DBUILD_SHARED_LIBS=1
          -DCMAKE_DISABLE_FIND_PACKAGE_HarfBuzz=1
          -DCMAKE_DISABLE_FIND_PACKAGE_BZip2=1
          -DCMAKE_DISABLE_FIND_PACKAGE_BrotliDec=1
          -DFT_REQUIRE_PNG=ON
          -DFT_REQUIRE_ZLIB=ON
          -DPNG_LIBRARY=${{ github.workspace }}/deps/lib/libpng.a
          -DPNG_PNG_INCLUDE_DIR=${{ github.workspace }}/deps/include
          -DZLIB_LIBRARY=${{ github.workspace }}/deps/lib/libz.a
          -DZLIB_INCLUDE_DIR=${{ github.workspace }}/deps/include
          -DCMAKE_POLICY_VERSION_MINIMUM=3.5
          ${{ matrix.platform.flags }}

      - name: Build (CMake)
        id: build
        run: |
          cmake --build build/ --config Release --parallel

      - uses: actions/upload-artifact@v4
        with:
          name: FreeType Artifacts ${{ matrix.platform.name }}
          path: |
            build/Release/*.dll
            build/Release/*.lib
            build/*.so
            build/*.dylib
